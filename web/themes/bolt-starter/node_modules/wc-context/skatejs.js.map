{"version":3,"file":"skatejs.js","sources":["../src/core.js","../src/skatejs.js"],"sourcesContent":["const orphanMap = {}\n\nconst resolved = Promise.resolve()\n\nconst orphanResolveQueue = {\n  contexts: new Set(),\n  running: false,\n  add (context) {\n    this.contexts.add(context)\n    if (!this.running) {\n      this.running = true\n      resolved.then(() => {\n        this.contexts.forEach(context => {\n          const orphans = orphanMap[context]\n          orphans.forEach(orphan => {\n            const event = sendContextEvent(orphan, context)\n            if (event.detail.handled) {\n              orphans.delete(orphan)\n            }\n          })\n        })\n        this.contexts.clear()\n        this.running = false\n      })\n    }\n  }\n}\n\nfunction addOrphan (el, name) {\n  const orphans = orphanMap[name] || (orphanMap[name] = new Set())\n  orphans.add(el)\n}\n\nfunction removeOrphan (el, name) {\n  const orphans = orphanMap[name]\n  if (orphans) {\n    orphans.delete(el)\n  }\n}\n\nfunction sendContextEvent (el, name) {\n  const event = new CustomEvent(`context-request-${name}`, {\n    detail: {},\n    bubbles: true,\n    cancelable: true,\n    composed: true\n  })\n  el.dispatchEvent(event)\n  return event\n}\n\nfunction registerProvidedContext (el, name, providedContexts) {\n  const observerMap = el.__wcContextObserverMap || (el.__wcContextObserverMap = {})\n  const observers = observerMap[name] || (observerMap[name] = [])\n  const orphans = orphanMap[name]\n  el.addEventListener(`context-request-${name}`, (event) => {\n    event.stopPropagation()\n    const targetEl = event.target\n    const value = providedContexts[name]\n    const context = targetEl.context\n    const oldValue = context[name]\n    if (oldValue !== value) {\n      context[name] = value\n      if (targetEl.contextChangedCallback) {\n        targetEl.contextChangedCallback(name, oldValue, value)\n      }\n    }\n    observers.push(targetEl)\n    event.detail.handled = true\n  })\n  if (orphans && orphans.size) {\n    orphanResolveQueue.add(name)\n  }\n}\n\nfunction observeContext (el, name) {\n  const event = sendContextEvent(el, name)\n  if (!event.detail.handled) {\n    addOrphan(el, name)\n  }\n}\n\nfunction unobserveContext (el, name) {\n  removeOrphan(el, name)\n}\n\nfunction notifyContextChange (el, name, value) {\n  const observerMap = el.__wcContextObserverMap\n  const observers = observerMap && observerMap[name]\n  if (observers) {\n    observers.forEach(observer => {\n      const context = observer.context\n      const oldValue = context[name]\n      if (oldValue !== value) {\n        context[name] = value\n        if (observer.contextChangedCallback) {\n          observer.contextChangedCallback(name, oldValue, value)\n        }\n      }\n    })\n  }\n}\n\nexport {registerProvidedContext, observeContext, unobserveContext, notifyContextChange}\n","\nimport { observeContext, unobserveContext, registerProvidedContext, notifyContextChange } from './core'\n\nconst initializedElements = new WeakSet()\n\nconst withContext = (Base) => {\n  return class extends Base {\n\n    get context () {\n      return this.__wcContext || (this.__wcContext = {})\n    }\n\n    connectedCallback () {\n      super.connectedCallback()\n      const observedContexts = this.constructor.observedContexts\n      if (observedContexts) {\n        observedContexts.forEach(context => observeContext(this, context))\n      }\n\n      if (!initializedElements.has(this)) {\n        const providedContextConfigs = this.constructor.providedContexts\n        if (providedContextConfigs) {\n          const providedContexts = this.__wcProvidedContexts || (this.__wcProvidedContexts = {})\n          const mappedProps = this.__wcMappedProps || (this.__wcMappedProps = {})\n          Object.keys(providedContextConfigs).forEach(name => {\n            const config = providedContextConfigs[name]\n            const property = typeof config === 'string' ? config : config.property\n            providedContexts[name] = property ? this[property] : config.value\n            if (property) {\n              mappedProps[name] = property\n            }\n            registerProvidedContext(this, name, providedContexts)\n          })\n        }\n        initializedElements.add(this)\n      }\n    }\n\n    disconnectedCallback () {\n      super.disconnectedCallback()\n      const observedContexts = this.constructor.observedContexts\n      if (observedContexts) {\n        observedContexts.forEach(context => unobserveContext(this, context))\n      }\n    }\n\n    updated (props) {\n      super.updated(props)\n      const mappedProps = this.__wcMappedProps\n      if (mappedProps) {\n        const providedContexts = this.__wcProvidedContexts || (this.__wcProvidedContexts = {})\n        Object.keys(mappedProps).forEach(contextName => {\n          const property = mappedProps[contextName]\n          if (property in props) {\n            const value = this[property]\n            providedContexts[contextName] = value\n            notifyContextChange(this, contextName, value)            \n          }\n        })        \n      }\n    }\n  }\n}\n\nexport { withContext }\n"],"names":["orphanMap","resolved","Promise","resolve","orphanResolveQueue","contexts","Set","running","add","context","then","forEach","orphans","orphan","event","sendContextEvent","detail","handled","delete","clear","addOrphan","el","name","removeOrphan","CustomEvent","bubbles","cancelable","composed","dispatchEvent","registerProvidedContext","providedContexts","observerMap","__wcContextObserverMap","observers","addEventListener","stopPropagation","targetEl","target","value","oldValue","contextChangedCallback","push","size","observeContext","unobserveContext","notifyContextChange","observer","initializedElements","WeakSet","withContext","Base","__wcContext","connectedCallback","observedContexts","constructor","has","providedContextConfigs","__wcProvidedContexts","mappedProps","__wcMappedProps","Object","keys","config","property","disconnectedCallback","updated","props","contextName"],"mappings":"AAAA,MAAMA,SAAS,GAAG,EAAlB;AAEA,MAAMC,QAAQ,GAAGC,OAAO,CAACC,OAAR,EAAjB;AAEA,MAAMC,kBAAkB,GAAG;EACzBC,QAAQ,EAAE,IAAIC,GAAJ,EADe;EAEzBC,OAAO,EAAE,KAFgB;;EAGzBC,GAAG,CAAEC,OAAF,EAAW;SACPJ,QAAL,CAAcG,GAAd,CAAkBC,OAAlB;;QACI,CAAC,KAAKF,OAAV,EAAmB;WACZA,OAAL,GAAe,IAAf;MACAN,QAAQ,CAACS,IAAT,CAAc,MAAM;aACbL,QAAL,CAAcM,OAAd,CAAsBF,OAAO,IAAI;gBACzBG,OAAO,GAAGZ,SAAS,CAACS,OAAD,CAAzB;UACAG,OAAO,CAACD,OAAR,CAAgBE,MAAM,IAAI;kBAClBC,KAAK,GAAGC,gBAAgB,CAACF,MAAD,EAASJ,OAAT,CAA9B;;gBACIK,KAAK,CAACE,MAAN,CAAaC,OAAjB,EAA0B;cACxBL,OAAO,CAACM,MAAR,CAAeL,MAAf;;WAHJ;SAFF;aASKR,QAAL,CAAcc,KAAd;aACKZ,OAAL,GAAe,KAAf;OAXF;;;;CAPN;;AAwBA,SAASa,SAAT,CAAoBC,EAApB,EAAwBC,IAAxB,EAA8B;QACtBV,OAAO,GAAGZ,SAAS,CAACsB,IAAD,CAAT,KAAoBtB,SAAS,CAACsB,IAAD,CAAT,GAAkB,IAAIhB,GAAJ,EAAtC,CAAhB;EACAM,OAAO,CAACJ,GAAR,CAAYa,EAAZ;;;AAGF,SAASE,YAAT,CAAuBF,EAAvB,EAA2BC,IAA3B,EAAiC;QACzBV,OAAO,GAAGZ,SAAS,CAACsB,IAAD,CAAzB;;MACIV,OAAJ,EAAa;IACXA,OAAO,CAACM,MAAR,CAAeG,EAAf;;;;AAIJ,SAASN,gBAAT,CAA2BM,EAA3B,EAA+BC,IAA/B,EAAqC;QAC7BR,KAAK,GAAG,IAAIU,WAAJ,CAAiB,mBAAkBF,IAAK,EAAxC,EAA2C;IACvDN,MAAM,EAAE,EAD+C;IAEvDS,OAAO,EAAE,IAF8C;IAGvDC,UAAU,EAAE,IAH2C;IAIvDC,QAAQ,EAAE;GAJE,CAAd;EAMAN,EAAE,CAACO,aAAH,CAAiBd,KAAjB;SACOA,KAAP;;;AAGF,SAASe,uBAAT,CAAkCR,EAAlC,EAAsCC,IAAtC,EAA4CQ,gBAA5C,EAA8D;QACtDC,WAAW,GAAGV,EAAE,CAACW,sBAAH,KAA8BX,EAAE,CAACW,sBAAH,GAA4B,EAA1D,CAApB;QACMC,SAAS,GAAGF,WAAW,CAACT,IAAD,CAAX,KAAsBS,WAAW,CAACT,IAAD,CAAX,GAAoB,EAA1C,CAAlB;QACMV,OAAO,GAAGZ,SAAS,CAACsB,IAAD,CAAzB;EACAD,EAAE,CAACa,gBAAH,CAAqB,mBAAkBZ,IAAK,EAA5C,EAAgDR,KAAD,IAAW;IACxDA,KAAK,CAACqB,eAAN;UACMC,QAAQ,GAAGtB,KAAK,CAACuB,MAAvB;UACMC,KAAK,GAAGR,gBAAgB,CAACR,IAAD,CAA9B;UACMb,OAAO,GAAG2B,QAAQ,CAAC3B,OAAzB;UACM8B,QAAQ,GAAG9B,OAAO,CAACa,IAAD,CAAxB;;QACIiB,QAAQ,KAAKD,KAAjB,EAAwB;MACtB7B,OAAO,CAACa,IAAD,CAAP,GAAgBgB,KAAhB;;UACIF,QAAQ,CAACI,sBAAb,EAAqC;QACnCJ,QAAQ,CAACI,sBAAT,CAAgClB,IAAhC,EAAsCiB,QAAtC,EAAgDD,KAAhD;;;;IAGJL,SAAS,CAACQ,IAAV,CAAeL,QAAf;IACAtB,KAAK,CAACE,MAAN,CAAaC,OAAb,GAAuB,IAAvB;GAbF;;MAeIL,OAAO,IAAIA,OAAO,CAAC8B,IAAvB,EAA6B;IAC3BtC,kBAAkB,CAACI,GAAnB,CAAuBc,IAAvB;;;;AAIJ,SAASqB,cAAT,CAAyBtB,EAAzB,EAA6BC,IAA7B,EAAmC;QAC3BR,KAAK,GAAGC,gBAAgB,CAACM,EAAD,EAAKC,IAAL,CAA9B;;MACI,CAACR,KAAK,CAACE,MAAN,CAAaC,OAAlB,EAA2B;IACzBG,SAAS,CAACC,EAAD,EAAKC,IAAL,CAAT;;;;AAIJ,SAASsB,gBAAT,CAA2BvB,EAA3B,EAA+BC,IAA/B,EAAqC;EACnCC,YAAY,CAACF,EAAD,EAAKC,IAAL,CAAZ;;;AAGF,SAASuB,mBAAT,CAA8BxB,EAA9B,EAAkCC,IAAlC,EAAwCgB,KAAxC,EAA+C;QACvCP,WAAW,GAAGV,EAAE,CAACW,sBAAvB;QACMC,SAAS,GAAGF,WAAW,IAAIA,WAAW,CAACT,IAAD,CAA5C;;MACIW,SAAJ,EAAe;IACbA,SAAS,CAACtB,OAAV,CAAkBmC,QAAQ,IAAI;YACtBrC,OAAO,GAAGqC,QAAQ,CAACrC,OAAzB;YACM8B,QAAQ,GAAG9B,OAAO,CAACa,IAAD,CAAxB;;UACIiB,QAAQ,KAAKD,KAAjB,EAAwB;QACtB7B,OAAO,CAACa,IAAD,CAAP,GAAgBgB,KAAhB;;YACIQ,QAAQ,CAACN,sBAAb,EAAqC;UACnCM,QAAQ,CAACN,sBAAT,CAAgClB,IAAhC,EAAsCiB,QAAtC,EAAgDD,KAAhD;;;KANN;;;;ACvFJ,MAAMS,mBAAmB,GAAG,IAAIC,OAAJ,EAA5B;;AAEA,MAAMC,WAAW,GAAIC,IAAD,IAAU;SACrB,cAAcA,IAAd,CAAmB;QAEpBzC,OAAJ,GAAe;aACN,KAAK0C,WAAL,KAAqB,KAAKA,WAAL,GAAmB,EAAxC,CAAP;;;IAGFC,iBAAiB,GAAI;YACbA,iBAAN;YACMC,gBAAgB,GAAG,KAAKC,WAAL,CAAiBD,gBAA1C;;UACIA,gBAAJ,EAAsB;QACpBA,gBAAgB,CAAC1C,OAAjB,CAAyBF,OAAO,IAAIkC,cAAc,CAAC,IAAD,EAAOlC,OAAP,CAAlD;;;UAGE,CAACsC,mBAAmB,CAACQ,GAApB,CAAwB,IAAxB,CAAL,EAAoC;cAC5BC,sBAAsB,GAAG,KAAKF,WAAL,CAAiBxB,gBAAhD;;YACI0B,sBAAJ,EAA4B;gBACpB1B,gBAAgB,GAAG,KAAK2B,oBAAL,KAA8B,KAAKA,oBAAL,GAA4B,EAA1D,CAAzB;gBACMC,WAAW,GAAG,KAAKC,eAAL,KAAyB,KAAKA,eAAL,GAAuB,EAAhD,CAApB;UACAC,MAAM,CAACC,IAAP,CAAYL,sBAAZ,EAAoC7C,OAApC,CAA4CW,IAAI,IAAI;kBAC5CwC,MAAM,GAAGN,sBAAsB,CAAClC,IAAD,CAArC;kBACMyC,QAAQ,GAAG,OAAOD,MAAP,KAAkB,QAAlB,GAA6BA,MAA7B,GAAsCA,MAAM,CAACC,QAA9D;YACAjC,gBAAgB,CAACR,IAAD,CAAhB,GAAyByC,QAAQ,GAAG,KAAKA,QAAL,CAAH,GAAoBD,MAAM,CAACxB,KAA5D;;gBACIyB,QAAJ,EAAc;cACZL,WAAW,CAACpC,IAAD,CAAX,GAAoByC,QAApB;;;YAEFlC,uBAAuB,CAAC,IAAD,EAAOP,IAAP,EAAaQ,gBAAb,CAAvB;WAPF;;;QAUFiB,mBAAmB,CAACvC,GAApB,CAAwB,IAAxB;;;;IAIJwD,oBAAoB,GAAI;YAChBA,oBAAN;YACMX,gBAAgB,GAAG,KAAKC,WAAL,CAAiBD,gBAA1C;;UACIA,gBAAJ,EAAsB;QACpBA,gBAAgB,CAAC1C,OAAjB,CAAyBF,OAAO,IAAImC,gBAAgB,CAAC,IAAD,EAAOnC,OAAP,CAApD;;;;IAIJwD,OAAO,CAAEC,KAAF,EAAS;YACRD,OAAN,CAAcC,KAAd;YACMR,WAAW,GAAG,KAAKC,eAAzB;;UACID,WAAJ,EAAiB;cACT5B,gBAAgB,GAAG,KAAK2B,oBAAL,KAA8B,KAAKA,oBAAL,GAA4B,EAA1D,CAAzB;QACAG,MAAM,CAACC,IAAP,CAAYH,WAAZ,EAAyB/C,OAAzB,CAAiCwD,WAAW,IAAI;gBACxCJ,QAAQ,GAAGL,WAAW,CAACS,WAAD,CAA5B;;cACIJ,QAAQ,IAAIG,KAAhB,EAAuB;kBACf5B,KAAK,GAAG,KAAKyB,QAAL,CAAd;YACAjC,gBAAgB,CAACqC,WAAD,CAAhB,GAAgC7B,KAAhC;YACAO,mBAAmB,CAAC,IAAD,EAAOsB,WAAP,EAAoB7B,KAApB,CAAnB;;SALJ;;;;GA7CN;CADF;;;;"}